<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Login</title>
    <link rel="stylesheet" href="styles.css">
    <script src="config.js"></script>
</head>

<body>
    <div class="container">
        <form name="form-login">
            <h4>Acessar Sistema</h4>
            <input type="hidden" name="action" value="login">

            <input type="text" name="loginInput" placeholder="Código, CPF ou Email" required>

            <div class="password-container">
                <input type="password" name="senha" id="senha-login" placeholder="Sua Senha" required>
                <span class="toggle-password" onclick="togglePassword('senha-login')"><svg width="24" height="24"
                        viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M16 12C16 14.2091 14.2091 16 12 16C9.79086 16 8 14.2091 8 12C8 9.79086 9.79086 8 12 8C14.2091 8 16 9.79086 16 12ZM14 12C14 13.1046 13.1046 14 12 14C10.8954 14 10 13.1046 10 12C10 10.8954 10.8954 10 12 10C13.1046 10 14 10.8954 14 12Z"
                            fill="currentColor" />
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M12 3C17.5915 3 22.2898 6.82432 23.6219 12C22.2898 17.1757 17.5915 21 12 21C6.40848 21 1.71018 17.1757 0.378052 12C1.71018 6.82432 6.40848 3 12 3ZM12 19C7.52443 19 3.73132 16.0581 2.45723 12C3.73132 7.94186 7.52443 5 12 5C16.4756 5 20.2687 7.94186 21.5428 12C20.2687 16.0581 16.4756 19 12 19Z"
                            fill="currentColor" />
                    </svg></span>
            </div>

            <input type="submit" value="Entrar" id="bt-login">

            <div id="offline-area" class="offline-box">
                <p><strong>Sem conexão com o servidor.</strong></p>
                <p style="font-size: 13px;">Deseja acessar o sistema em modo limitado?</p>
                <p style="font-size: 12px;">Seu progresso não será salvo.</p>
                <button type="button" class="btn-offline" onclick="entrarOffline()">Entrar Offline</button>
            </div>

            <p style="margin-top:10px; font-size: 14px;">
                Não tem conta? <a href="cadastro.html">Cadastre-se</a>
            </p>
        </form>
    </div>

    <script>
        function togglePassword(fieldId) {
            const input = document.getElementById(fieldId);
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
        }

        // Função para simular Timeout (se demorar mais de 5s, gera erro)
        async function fetchWithTimeout(resource, options = {}) {
            const { timeout = 5000 } = options; // 5 segundos padrão

            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);

            const response = await fetch(resource, {
                ...options,
                signal: controller.signal
            });
            clearTimeout(id);
            return response;
        }

        const formLogin = document.forms['form-login'];
        const offlineArea = document.getElementById('offline-area');

        formLogin.addEventListener('submit', function (e) {
            e.preventDefault();

            // Esconde a caixa offline se ela estava aberta antes
            offlineArea.style.display = 'none';

            const botao = document.getElementById('bt-login');
            botao.value = "Conectando...";
            botao.disabled = true;

            // Usa a função com timeout de 5 segundos
            fetchWithTimeout(config.script_url, {
                method: 'POST',
                body: new FormData(formLogin),
                timeout: 5000
            })
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success') {
                        localStorage.setItem('usuarioNome', data.username);
                        localStorage.setItem('usuarioCodigo', data.codigo); // <--- Adicione isso
                        localStorage.setItem('nivelDigita', data.fase);     // <--- E isso (sincroniza progresso)
                        window.location.href = "dashboard.html"; // ou direto para aula.html
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro de conexão:', error);
                    // AQUI É O PULO DO GATO: Se der erro, mostra a opção offline
                    offlineArea.style.display = 'block';
                })
                .finally(() => {
                    botao.value = "Entrar";
                    botao.disabled = false;
                });
        });

        // Função chamada ao clicar no botão cinza
        function entrarOffline() {
            localStorage.setItem('usuarioNome', 'Visitante Offline');
            localStorage.setItem('modoOffline', 'true'); // Marca que está offline
            window.location.href = "aula.html";
        }
    </script>
</body>

</html>